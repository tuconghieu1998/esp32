<main class="content">
    <div class="container-fluid p-0">
        <div class="row justify-content-between">
            <h1>Live Camera Feed</h1>
            <div style="position: relative; width: 750px;">
                <h5 class="card-title mb-0 pd-2">Factory 1</h5>
                <div id="factory-container" style="position: relative; width: 750px; height: 600px;">
                    <img id="factory-layout" src="/img/photos/factory_layout_1.png" style="width: 100%; height: auto;">

                    <!-- Sensor 1 -->
                    <a href="#" onclick="openModal('192.168.10.165')">
                        <div class="sensor" style="top: 10%; left: 20%;" data-id="sensor1"></div>
                    </a>
                    <!-- Sensor 2 -->
                    <a href="#" onclick="openModal('192.168.10.166')">
                        <div class="sensor" style="top: 10%; left: 40%;" data-id="sensor2"></div>
                    </a>

                    <!-- Sensor 3 -->
                    <a href="#" onclick="openModal('192.168.10.167')">
                        <div class="sensor" style="top: 10%; left: 60%;" data-id="sensor3"></div>
                    </a>

                    <!-- Sensor 4 -->
                    <a href="#" onclick="openModal('192.168.10.168')">
                        <div class="sensor" style="top: 10%; left: 80%;" data-id="sensor4"></div>
                    </a>

                    <!-- Sensor 5 -->
                    <a href="#" onclick="openModal('192.168.10.169')">
                        <div class="sensor" style="top: 80%; left: 20%;" data-id="sensor5"></div>
                    </a>

                    <!-- Sensor 6 -->
                    <a href="#" onclick="openModal('192.168.10.170')">
                        <div class="sensor" style="top: 80%; left: 40%;" data-id="sensor6"></div>
                    </a>

                    <!-- Sensor 7 -->
                    <a href="#" onclick="openModal('192.168.10.171')">
                        <div class="sensor" style="top: 80%; left: 60%;" data-id="sensor7"></div>
                    </a>

                    <!-- Sensor 8 -->
                    <a href="#" onclick="openModal('192.168.10.172')">
                        <div class="sensor" style="top: 80%; left: 80%;" data-id="sensor8"></div>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Fullscreen Bootstrap Modal -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Camera Stream</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <canvas id='canvas-camera'></canvas> <!-- Camera Stream Canvas -->
                </div>
            </div>
        </div>
    </div>
</main>
<script src="/js/rtsp-relay.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        $(".sensor").hover(
            function () {
                $(this).addClass("hover-effect");
            },
            function () {
                $(this).removeClass("hover-effect");
            }
        );

        var sensors = [
            [1, 2, 3, 4, 5, 6, 7, 8],
            [9, 10, 11, 12, 13, 14, 15, 16],
            [17, 18, 19, 20, 21, 22, 23, 24],
            [25, 26, 27, 28, 29, 30, 31, 32]
        ];
    });

    function resizeCanvas() {
        const modalBody = document.getElementById('modalBody');
        const canvas = document.getElementById('canvas-camera');
        canvas.width = modalBody.clientWidth;  // Fit modal width
        canvas.height = modalBody.clientHeight; // Fit modal height
    }

    // Resize on load & window resize
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('beforeunload', closeWebSocket);

    let socket = null; // Store WebSocket instance globally

    function closeWebSocket() {
        console.log("closeWebSocket");
        if (socket) {
            console.log("close");
            socket.destroy();
        }
    }

    async function openModal(cameraIP) {
        console.log('openModal', cameraIP);

        try {
            const canvas = document.getElementById('canvas-camera');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            socket = await loadPlayer({
                url: `ws://${location.host}/api/stream/${cameraIP}`,
                canvas: canvas,
                wasmMemorySize: 64 * 1024 * 1024,
                disableGl: true,
                chunkSize: 512 * 1024,
                videoBufferSize: 1024 * 1024 * 8
            });

            console.log('üé• Player loaded:', cameraIP);

            // Show the modal
            let modal = new bootstrap.Modal(document.getElementById("cameraModal"));
            modal.show();

            // Close WebSocket when modal is hidden
            document.getElementById("cameraModal").addEventListener("hidden.bs.modal", closeWebSocket);
        } catch (error) {
            console.error('‚ùå Failed to load player:', error);
        }
    }

</script>